name: "Build Release Artifacts"
description: "Builds release artifacts (tar.gz, zip, Helm chart)"

inputs:
  javaVersion:
    description: "Java version"
    required: false
    default: "17"
  releaseVersion:
    description: "Release version (e.g., 1.5.0)"
    required: true
  runnerArch:
    description: "Runner architecture (amd64, arm64)"
    required: false
    default: "amd64"
  gpgPassphrase:
    description: "GPG passphrase for signing"
    required: true
  gpgSigningKey:
    description: "GPG signing key"
    required: true
  centralUsername:
    description: "Maven Central username"
    required: true
  centralPassword:
    description: "Maven Central password"
    required: true

runs:
  using: "composite"
  steps:
    - name: Setup Java
      uses: strimzi/strimzi-kafka-operator/.github/actions/dependencies/setup-java@main
      with:
        javaVersion: ${{ inputs.javaVersion }}

    - name: Restore Maven cache
      uses: actions/cache/restore@v5
      with:
        path: ~/.m2/repository
        key: maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          maven-

    - name: Configure release version to ${{ inputs.releaseVersion }}
      shell: bash
      run: "mvn versions:set -DnewVersion=$(echo ${{ inputs.releaseVersion }}| tr a-z A-Z)"

    - name: Build release artifacts
      shell: bash
      run: mvn install -DskipTests

    - name: Deploy Java artifacts
      shell: bash
      run: ./.azure/scripts/push-to-central.sh
      env:
        BUILD_REASON: "IndividualCI"
        BRANCH: ${{ github.ref }}
        GPG_PASSPHRASE: ${{ inputs.gpgPassphrase }}
        GPG_SIGNING_KEY: ${{ inputs.gpgSigningKey }}
        CENTRAL_USERNAME: ${{ inputs.centralUsername }}
        CENTRAL_PASSWORD: ${{ inputs.centralPassword }}

    - name: Create release archives tarball
      shell: bash
      run: |
        tar -cvpf release.tar \
          kafka-kubernetes-config-provider-${{ inputs.releaseVersion }}.tar.gz \
          kafka-kubernetes-config-provider-${{ inputs.releaseVersion }}.zip \
          kafka-kubernetes-config-provider-${{ inputs.releaseVersion }}.jar

    - name: Upload release archives
      uses: actions/upload-artifact@v5
      with:
        name: release.tar
        path: release.tar